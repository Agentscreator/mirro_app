<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Green Screen Video Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .video-container {
            text-align: center;
        }
        
        video, canvas, img {
            width: 100%;
            max-width: 400px;
            height: auto;
            border: 2px solid #ddd;
            border-radius: 4px;
        }
        
        .controls {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        
        .control-group {
            margin: 10px 0;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        input[type="range"] {
            width: 100%;
            margin: 5px 0;
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .file-input {
            margin: 10px 0;
        }
        
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Green Screen Video Processor Test</h1>
        <p>Upload a green screen video and background image to test chroma keying functionality.</p>
        
        <div class="file-input">
            <label for="videoFile">Select Green Screen Video:</label>
            <input type="file" id="videoFile" accept="video/*">
        </div>
        
        <div class="file-input">
            <label for="backgroundFile">Select Background Image:</label>
            <input type="file" id="backgroundFile" accept="image/*">
        </div>
        
        <div class="video-grid">
            <div class="video-container">
                <h3>Original Video</h3>
                <video id="sourceVideo" muted loop controls></video>
            </div>
            
            <div class="video-container">
                <h3>Background Image</h3>
                <img id="backgroundImage" alt="Background will appear here">
            </div>
            
            <div class="video-container">
                <h3>Processed Result</h3>
                <canvas id="outputCanvas"></canvas>
            </div>
        </div>
        
        <div class="controls">
            <h3>Chroma Key Controls</h3>
            
            <div class="control-group">
                <label for="threshold">Threshold: <span id="thresholdValue">0.40</span></label>
                <input type="range" id="threshold" min="0" max="1" step="0.01" value="0.4">
            </div>
            
            <div class="control-group">
                <label for="smoothness">Edge Smoothness: <span id="smoothnessValue">0.10</span></label>
                <input type="range" id="smoothness" min="0" max="0.5" step="0.01" value="0.1">
            </div>
            
            <div class="control-group">
                <label for="spill">Spill Suppression: <span id="spillValue">0.10</span></label>
                <input type="range" id="spill" min="0" max="0.5" step="0.01" value="0.1">
            </div>
            
            <div class="control-group">
                <button id="playBtn">Play</button>
                <button id="pauseBtn">Pause</button>
                <button id="analyzeBtn">Auto-Analyze Settings</button>
                <button id="downloadBtn" disabled>Download Result</button>
            </div>
        </div>
        
        <div id="status" class="status" style="display: none;"></div>
    </div>

    <script>
        class GreenScreenProcessor {
            constructor() {
                this.video = document.getElementById('sourceVideo');
                this.canvas = document.getElementById('outputCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.backgroundImg = document.getElementById('backgroundImage');
                
                this.isProcessing = false;
                this.animationFrame = null;
                
                this.settings = {
                    threshold: 0.4,
                    smoothness: 0.1,
                    spill: 0.1
                };
                
                this.setupEventListeners();
            }
            
            setupEventListeners() {
                // File uploads
                document.getElementById('videoFile').addEventListener('change', (e) => {
                    this.loadVideo(e.target.files[0]);
                });
                
                document.getElementById('backgroundFile').addEventListener('change', (e) => {
                    this.loadBackground(e.target.files[0]);
                });
                
                // Controls
                document.getElementById('playBtn').addEventListener('click', () => this.play());
                document.getElementById('pauseBtn').addEventListener('click', () => this.pause());
                document.getElementById('analyzeBtn').addEventListener('click', () => this.analyzeFrame());
                document.getElementById('downloadBtn').addEventListener('click', () => this.downloadResult());
                
                // Sliders
                ['threshold', 'smoothness', 'spill'].forEach(param => {
                    const slider = document.getElementById(param);
                    const valueSpan = document.getElementById(param + 'Value');
                    
                    slider.addEventListener('input', (e) => {
                        const value = parseFloat(e.target.value);
                        this.settings[param] = value;
                        valueSpan.textContent = value.toFixed(2);
                    });
                });
            }
            
            loadVideo(file) {
                if (!file) return;
                
                const url = URL.createObjectURL(file);
                this.video.src = url;
                
                this.video.onloadeddata = () => {
                    this.showStatus('Video loaded successfully');
                    this.updateCanvasSize();
                };
            }
            
            loadBackground(file) {
                if (!file) return;
                
                const url = URL.createObjectURL(file);
                this.backgroundImg.src = url;
                
                this.backgroundImg.onload = () => {
                    this.showStatus('Background image loaded successfully');
                };
            }
            
            updateCanvasSize() {
                if (this.video.videoWidth && this.video.videoHeight) {
                    this.canvas.width = this.video.videoWidth;
                    this.canvas.height = this.video.videoHeight;
                }
            }
            
            play() {
                if (!this.video.src || !this.backgroundImg.src) {
                    this.showStatus('Please load both video and background image first', 'error');
                    return;
                }
                
                this.video.play();
                this.isProcessing = true;
                this.processFrame();
                document.getElementById('downloadBtn').disabled = false;
            }
            
            pause() {
                this.video.pause();
                this.isProcessing = false;
                if (this.animationFrame) {
                    cancelAnimationFrame(this.animationFrame);
                }
            }
            
            processFrame() {
                if (!this.isProcessing) return;
                
                this.updateCanvasSize();
                
                // Draw video frame
                this.ctx.drawImage(this.video, 0, 0, this.canvas.width, this.canvas.height);
                
                // Get image data
                const imageData = this.ctx.getImageData(0, 0, this.canvas.width, this.canvas.height);
                
                // Create background canvas
                const bgCanvas = document.createElement('canvas');
                bgCanvas.width = this.canvas.width;
                bgCanvas.height = this.canvas.height;
                const bgCtx = bgCanvas.getContext('2d');
                bgCtx.drawImage(this.backgroundImg, 0, 0, this.canvas.width, this.canvas.height);
                const bgImageData = bgCtx.getImageData(0, 0, this.canvas.width, this.canvas.height);
                
                // Process chroma key
                this.applyChromaKey(imageData, bgImageData);
                
                // Put processed data back
                this.ctx.putImageData(imageData, 0, 0);
                
                this.animationFrame = requestAnimationFrame(() => this.processFrame());
            }
            
            applyChromaKey(imageData, bgImageData) {
                const data = imageData.data;
                const bgData = bgImageData.data;
                const { threshold, smoothness, spill } = this.settings;
                
                for (let i = 0; i < data.length; i += 4) {
                    const r = data[i];
                    const g = data[i + 1];
                    const b = data[i + 2];
                    
                    // Calculate green screen detection
                    const greenness = (g - Math.max(r, b)) / 255;
                    
                    // Calculate alpha with smoothing
                    let alpha = 1.0;
                    if (greenness > threshold - smoothness) {
                        if (greenness > threshold + smoothness) {
                            alpha = 0.0;
                        } else {
                            // Smooth transition
                            alpha = 1.0 - (greenness - (threshold - smoothness)) / (2 * smoothness);
                        }
                    }
                    
                    // Apply spill suppression
                    if (alpha > 0 && alpha < 1 && spill > 0) {
                        const spillAmount = (1 - alpha) * spill;
                        data[i] = Math.max(0, Math.min(255, r - g * spillAmount * 0.5));
                        data[i + 2] = Math.max(0, Math.min(255, b - g * spillAmount * 0.5));
                    }
                    
                    // Composite with background
                    if (alpha < 1) {
                        data[i] = Math.round(data[i] * alpha + bgData[i] * (1 - alpha));
                        data[i + 1] = Math.round(data[i + 1] * alpha + bgData[i + 1] * (1 - alpha));
                        data[i + 2] = Math.round(data[i + 2] * alpha + bgData[i + 2] * (1 - alpha));
                    }
                }
            }
            
            analyzeFrame() {
                if (!this.video.src) {
                    this.showStatus('Please load a video first', 'error');
                    return;
                }
                
                this.updateCanvasSize();
                this.ctx.drawImage(this.video, 0, 0, this.canvas.width, this.canvas.height);
                const imageData = this.ctx.getImageData(0, 0, this.canvas.width, this.canvas.height);
                
                const analysis = this.analyzeGreenScreen(imageData);
                
                // Update sliders with analyzed values
                document.getElementById('threshold').value = analysis.threshold;
                document.getElementById('smoothness').value = analysis.smoothness;
                document.getElementById('spill').value = analysis.spill;
                
                document.getElementById('thresholdValue').textContent = analysis.threshold.toFixed(2);
                document.getElementById('smoothnessValue').textContent = analysis.smoothness.toFixed(2);
                document.getElementById('spillValue').textContent = analysis.spill.toFixed(2);
                
                this.settings = analysis;
                
                this.showStatus('Settings auto-analyzed and applied');
            }
            
            analyzeGreenScreen(imageData) {
                const data = imageData.data;
                const greenPixels = [];
                
                // Sample green pixels
                for (let i = 0; i < data.length; i += 16) {
                    const r = data[i];
                    const g = data[i + 1];
                    const b = data[i + 2];
                    
                    if (g > r + 30 && g > b + 30 && g > 100) {
                        greenPixels.push({ r, g, b });
                    }
                }
                
                if (greenPixels.length === 0) {
                    return { threshold: 0.4, smoothness: 0.1, spill: 0.1 };
                }
                
                const avgGreen = greenPixels.reduce((sum, p) => sum + p.g, 0) / greenPixels.length;
                const avgRed = greenPixels.reduce((sum, p) => sum + p.r, 0) / greenPixels.length;
                const avgBlue = greenPixels.reduce((sum, p) => sum + p.b, 0) / greenPixels.length;
                
                const variance = greenPixels.reduce((sum, p) => {
                    const diff = p.g - avgGreen;
                    return sum + diff * diff;
                }, 0) / greenPixels.length;
                
                const normalizedVariance = Math.sqrt(variance) / 255;
                
                return {
                    threshold: Math.max(0.2, Math.min(0.8, (avgGreen - Math.max(avgRed, avgBlue)) / 255)),
                    smoothness: Math.max(0.05, Math.min(0.3, normalizedVariance)),
                    spill: Math.max(0.05, Math.min(0.2, normalizedVariance * 0.5))
                };
            }
            
            downloadResult() {
                const stream = this.canvas.captureStream(30);
                const mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
                const chunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        chunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = () => {
                    const blob = new Blob(chunks, { type: 'video/webm' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'green-screen-result.webm';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    this.showStatus('Video downloaded successfully');
                };
                
                mediaRecorder.start();
                
                // Record for 10 seconds or video duration
                const duration = Math.min(this.video.duration * 1000, 10000);
                setTimeout(() => {
                    mediaRecorder.stop();
                }, duration);
                
                this.showStatus('Recording video... This may take a moment.');
            }
            
            showStatus(message, type = 'success') {
                const statusDiv = document.getElementById('status');
                statusDiv.textContent = message;
                statusDiv.style.display = 'block';
                
                if (type === 'error') {
                    statusDiv.style.background = '#f8d7da';
                    statusDiv.style.borderColor = '#f5c6cb';
                    statusDiv.style.color = '#721c24';
                } else {
                    statusDiv.style.background = '#d4edda';
                    statusDiv.style.borderColor = '#c3e6cb';
                    statusDiv.style.color = '#155724';
                }
                
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }
        
        // Initialize the processor when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new GreenScreenProcessor();
        });
    </script>
</body>
</html>